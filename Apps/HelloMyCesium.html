<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- Use correct character set. -->
        <meta charset="utf-8" />
        <!-- Tell IE to use the latest, best version. -->
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
        />
        <title>Hello My Cesium</title>
        <!-- <script src="../Build/Cesium/Cesium.js"></script> -->
        <style>
            @import url(../Build/Cesium/Widgets/widgets.css);
            html,
            body,
            #cesiumContainer {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                overflow: hidden;
            }
        </style>
    </head>
    <body>
        <div id="cesiumContainer"></div>
        <script type="module">
            window.CESIUM_BASE_URL = '../Source';
            import * as Cesium from '../Source/Cesium.js';
            /* eslint-disable */
            var _roam = true;
            var _originXY = {
                lng: 116.790876,
                lat: 36.498399,
                height: 0,
                mercX: 13001100.84,
                mercY: 4369418.66,
                roamH: 135,
                dixiaModelH: -22.5,
                dishangModelH: 12
            }; //模型原点
            var _originCamera = {
                position: new Cesium.Cartesian3.fromDegrees(
                    116.794479,
                    36.495727,
                    500
                ),
                // position: new Cesium.Cartesian3.fromDegrees(114.78024, 28.50369, 1000),
                direction: {
                    //heading: 0.421,
                    heading: 0,
                    pitch: Cesium.Math.toRadians(-35.0),
                    roll: 0.0
                },
                up: new Cesium.Cartesian3(0, 0, 1)
            }; //相机初始位置

            var viewer = new Cesium.Viewer('cesiumContainer', {
                animation: false,
                baseLayerPicker: false,
                geocoder: false,
                timeline: false,
                infobox: false,
                navigationHelpButton: false,
                sceneModePicker: false,
                scene3DOnly: true,
                homeButton: false,
                infoBox: false,
                selectionIndicator: false,
                fullscreenButton: false,
                //shadows: true,
                //terrainShadows:Cesium.ShadowMode.ENABLED,
                shouldAnimate: true,
                //高德
                imageryProvider: new Cesium.UrlTemplateImageryProvider({
                    url:
                        'https://webst04.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}',
                    // 'http://www.google.cn/maps/vt?lyrs=s&x={x}&y={y}&z={z}',
                    maximumLevel: 18,
                    tileMatrixSetID: 'GoogleMapsCompatible'
                })
            });
            viewer.scene.globe.depthTestAgainstTerrain = false;
            //阴影设置
            viewer.shadowMap.softShadows = true;
            //viewer.scene.globe.enableLighting = true;
            viewer.shadowMap.maximumDistance = 1000;
            //模型显示不完整
            viewer.scene.logarithmicDepthBuffer = false;
            //viewer.scene.farToNearRatio = 1;
            // setTimeout(function() {
            //     viewer.camera.flyTo({
            //         destination: _originCamera.position,
            //         complete: function() {
            //             viewer.camera.flyTo({
            //                 destination: _originCamera.position,
            //                 orientation: _originCamera.direction,
            //                 duration: 0.1,
            //                 complete: function() {}
            //             });
            //         }
            //     });
            // }, 2000);
            viewer.scene.screenSpaceCameraController.rotateEventTypes = [
                Cesium.CameraEventType.LEFT_DRAG
            ];
            viewer.scene.screenSpaceCameraController.zoomEventTypes = [
                //Cesium.CameraEventType.MIDDLE_DRAG,
                Cesium.CameraEventType.WHEEL
                //Cesium.CameraEventType.PINCH
            ];
            //加载模型
            var _roadModel = new Cesium.PrimitiveCollection({
                show: true,
                destroyPrimitives: true
            });
            var model = new Cesium.Cesium3DTileset({
                url: 'http://localhost:8082/compare_with_glb/tileset.json',
                luminanceAtZenith: 1,
                lightColor: new Cesium.Cartesian3(1, 1, 1),
                // immediatelyLoadDesiredLevelOfDetail: true,
                maximumScreenSpaceError: 16,
                debugShowGeometricError: false,
                // debugShowBoundingVolume: true
                //debugShowUrl: true,
                // loadSiblings: true
                maximumMemoryUsage: 512,
                dynamicScreenSpaceError: true
            });
            _changeModelPosition(model, 0, 0, 200);
            _roadModel.add(model);
            viewer.scene.primitives.add(_roadModel);
            viewer.camera.moveEnd.addEventListener(function(e) {
                var pos = Cesium.Cartographic.fromCartesian(
                    viewer.camera.position
                );
                console.log('camera height: ' + pos.height);
            });
            //球体
            var ball = viewer.entities.add({
                name: 'ball',
                position: Cesium.Cartesian3.fromDegrees(0, 0, 100),
                ellipsoid: {
                    radii: new Cesium.Cartesian3(0.5, 0.5, 0.5),
                    fill: true,
                    material: Cesium.Color.RED,
                    outline: false,
                    outlineColor: Cesium.Color.YELLOW,
                    slicePartitions: 24, //横向切割线  不能小于3
                    stackPartitions: 24 //纵向切割线   不能小于3
                }
            });
            //按键移动相机
            var keydown = function(e) {
                if (_roam) {
                    _movePosition(e, viewer, ball);
                }
            };
            document.addEventListener('keydown', keydown);
            var handler = new Cesium.ScreenSpaceEventHandler(
                viewer.scene.canvas
            );
            handler.setInputAction(function(movement) {
                var scene = viewer.scene;
                if (scene.mode !== Cesium.SceneMode.MORPHING) {
                    var pickedObject = scene.pick(movement.position);
                    if (
                        scene.pickPositionSupported &&
                        Cesium.defined(pickedObject)
                    ) {
                        var clickPos = Cesium.Cartographic.fromCartesian(
                            scene.pickPosition(movement.position)
                        );
                        if (Cesium.defined(pickedObject.tileset)) {
                            var name = pickedObject.getProperty('name');
                            console.log(
                                name + ' click height: ' + clickPos.height
                            );
                        }
                    }
                }
            }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

            //右键旋转视角
            var startMousePosition;
            var mousePosition;
            var turning = false;
            viewer.clock.onTick.addEventListener((clock) => {
                if (turning) {
                    var width = viewer.scene.canvas.clientWidth;
                    var height = viewer.scene.canvas.clientHeight;
                    var x = (mousePosition.x - startMousePosition.x) / width;
                    var y = -(mousePosition.y - startMousePosition.y) / height;
                    var lookFactor = 0.2;
                    viewer.camera.setView({
                        orientation: {
                            heading: viewer.camera.heading + x * lookFactor,
                            pitch: viewer.camera.pitch + y * lookFactor,
                            roll: 0
                        }
                    });
                }
            });
            handler.setInputAction(function(movement) {
                mousePosition = movement.endPosition;
            }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);
            handler.setInputAction(function(movement) {
                turning = true;
                mousePosition = startMousePosition = Cesium.Cartesian3.clone(
                    movement.position
                );
            }, Cesium.ScreenSpaceEventType.RIGHT_DOWN);
            handler.setInputAction(function(movement) {
                turning = false;
                mousePosition = startMousePosition = Cesium.Cartesian3.clone(
                    movement.position
                );
            }, Cesium.ScreenSpaceEventType.RIGHT_UP);

            function _intersectScene(viewer, start, objectsToExclude = null) {
                if (!Cesium.defined(objectsToExclude)) {
                    objectsToExclude =
                        viewer.scene.primitives._primitives[0]._primitives;
                }
                var ss = Cesium.Cartographic.fromCartesian(start);
                start = Cesium.Cartesian3.fromRadians(
                    ss.longitude,
                    ss.latitude,
                    ss.height - 0.5
                );
                var end = Cesium.Cartesian3.fromRadians(
                    ss.longitude,
                    ss.latitude,
                    ss.height - 10
                );
                var direction = Cesium.Cartesian3.normalize(
                    Cesium.Cartesian3.subtract(
                        end,
                        start,
                        new Cesium.Cartesian3()
                    ),
                    new Cesium.Cartesian3()
                );
                var ray = new Cesium.Ray(start, direction);
                return viewer.scene.pickFromRay(ray, objectsToExclude);
            }

            function _movePosition(e, viewer, entity) {
                var hoffset = 1;
                var position;
                var isCamare;
                if (entity.position.x) {
                    position = Cesium.Cartographic.fromCartesian(
                        entity.position
                    );
                    isCamare = true;
                } else {
                    position = Cesium.Cartographic.fromCartesian(
                        entity.position._value
                    );
                    isCamare = false;
                }
                var distance = 1.75e-7;
                var heading = viewer.camera.heading;
                var finalPos;
                switch (e.keyCode) {
                    case 'W'.charCodeAt(0):
                        finalPos = Cesium.Cartesian3.fromRadians(
                            (position.longitude +=
                                distance * Math.sin(heading)),
                            (position.latitude += distance * Math.cos(heading)),
                            position.height
                        );
                        var floor = _intersectScene(
                            viewer,
                            entity.position._value || entity.position,
                            _roadModel._primitives
                        );
                        if (floor && floor.position) {
                            var intersectedPos = Cesium.Cartographic.fromCartesian(
                                floor.position
                            );
                            finalPos = Cesium.Cartesian3.fromRadians(
                                position.longitude,
                                position.latitude,
                                intersectedPos.height + hoffset
                            );
                            console.log(
                                'intersect height: ' + intersectedPos.height
                            );
                        }
                        break;
                    case 'S'.charCodeAt(0):
                        finalPos = Cesium.Cartesian3.fromRadians(
                            (position.longitude -=
                                distance * Math.sin(heading)),
                            (position.latitude -= distance * Math.cos(heading)),
                            position.height
                        );
                        break;
                    case 'A'.charCodeAt(0):
                        finalPos = Cesium.Cartesian3.fromRadians(
                            (position.longitude -=
                                distance * Math.cos(heading)),
                            (position.latitude += distance * Math.sin(heading)),
                            position.height
                        );
                        break;
                    case 'D'.charCodeAt(0):
                        finalPos = Cesium.Cartesian3.fromRadians(
                            (position.longitude +=
                                distance * Math.cos(heading)),
                            (position.latitude -= distance * Math.sin(heading)),
                            position.height
                        );
                        break;
                    case 'Z'.charCodeAt(0):
                        finalPos = Cesium.Cartesian3.fromRadians(
                            position.longitude,
                            position.latitude,
                            (position.height += 1)
                        );
                        console.log('ball height: ' + position.height);
                        break;
                    case 'X'.charCodeAt(0):
                        finalPos = Cesium.Cartesian3.fromRadians(
                            position.longitude,
                            position.latitude,
                            (position.height -= 1)
                        );
                        console.log('ball height: ' + position.height);
                        break;
                }
                if (isCamare) {
                    entity.position = finalPos;
                } else {
                    entity.position.setValue(finalPos);
                }
            }
            function _changeModelPosition(tileset, lng, lat, height, adjust) {
                tileset.readyPromise.then(function(argument) {
                    var mat = Cesium.Matrix4.fromArray(tileset._root.transform);
                    var pos = Cesium.Matrix4.getTranslation(
                        mat,
                        new Cesium.Cartesian3()
                    );
                    var wpos = Cesium.Cartographic.fromCartesian(pos);
                    if (wpos) {
                        lng = Cesium.Math.toDegrees(wpos.longitude);
                        lat = Cesium.Math.toDegrees(wpos.latitude);
                        if (adjust) height = wpos.height + height;
                        else height = wpos.height + height + _originXY.height;
                    }

                    // var position = _originCamera.position;
                    var position = Cesium.Cartesian3.fromDegrees(
                        lng,
                        lat,
                        height
                    );
                    // var position = Cesium.Cartesian3.fromDegrees(
                    //   _originXY.lng,
                    //   _originXY.lat,
                    //   _originXY.height
                    // );
                    var mat = Cesium.Transforms.eastNorthUpToFixedFrame(
                        position
                    );
                    var rotationZZ = Cesium.Matrix4.fromRotationTranslation(
                        Cesium.Matrix3.fromRotationZ(Cesium.Math.toRadians(0))
                    );
                    Cesium.Matrix4.multiply(mat, rotationZZ, mat);
                    tileset._root.transform = mat;

                    viewer.camera.flyTo({
                        destination: Cesium.Cartesian3.fromDegrees(
                            116.895634,
                            36.652209,
                            height
                        ),
                        orientation: _originCamera.direction,
                        duration: 2,
                        complete: function() {
                            ball.position.setValue(
                                viewer.camera.position.clone()
                            );
                        }
                    });
                });
            }
        </script>
    </body>
</html>
