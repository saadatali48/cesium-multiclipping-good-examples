<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Use correct character set. -->
    <meta charset="utf-8" />
    <!-- Tell IE to use the latest, best version. -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no" />
    <title>3d tiles 展示</title>
    <style>
        @import url(../../../../Build/Cesium/Widgets/widgets.css);

        html,
        body,
        #cesiumContainer {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        button {
            position: absolute;
            z-index: 99;
        }
    </style>
</head>

<body>
    <script>
        function locate() {
            _viewer.zoomTo(
                _tileset,
                new Cesium.HeadingPitchRange(
                    0,
                    -2.0,
                    Math.max(100.0 - _tileset.boundingSphere.radius, 0.0)
                )
            );
        }
    </script>
    <div id="cesiumContainer">
        <button onclick="locate()">定位</button>
    </div>
    <script type="module">
        // import IndexedDbCache from "../Lib/indexDbCache.js";
        import * as Cesium from "../../../../Source/Cesium.js";
        window.CESIUM_BASE_URL = "../../../../Source";
        window.Cesium = Cesium;
        /* eslint-disable */
        var viewer;
        var modelHeight;
        viewer = new Cesium.Viewer("cesiumContainer", {
            shadows: true,
        });
        window._viewer = viewer;
        viewer.scene.logarithmicDepthBuffer = false;
        var tileset = viewer.scene.primitives.add(
            new Cesium.Cesium3DTileset({
                url: "https://localhost:8003/zt-Qzhou/models/pc/0/terra_b3dms/tileset.json",
                debugShowBoundingVolume: false,
                skipLevelOfDetail: true,
                shadows: Cesium.ShadowMode.DISABLED,
                preferLeaves: true,
                maximumScreenSpaceError: 2
            })
        );
        tileset.readyPromise.then(function() {
            _changeModelPosition(tileset, 120, 30, 100);
            viewer.zoomTo(
                tileset,
                new Cesium.HeadingPitchRange(
                    0,
                    -2.0,
                    Math.max(100.0 - tileset.boundingSphere.radius, 0.0)
                )
            );
            _enableTranslate()
        });
        window._tileset = tileset;

        function _changeModelPosition(tileset, lng, lat, height) {

            modelHeight = height;

            var cartographic = Cesium.Cartographic.fromCartesian(tileset.boundingSphere.center);
            var surface = Cesium.Cartesian3.fromRadians(cartographic.longitude, cartographic.latitude, cartographic.height);
            var offset = Cesium.Cartesian3.fromDegrees(cartographic.longitude, cartographic.latitude, cartographic.height + height);
            var translation = Cesium.Cartesian3.subtract(offset, surface, new Cesium.Cartesian3());

            var modelMatrix = new Cesium.Matrix4();
            var transMatrix = Cesium.Matrix4.fromTranslation(translation);
            Cesium.Matrix4.multiply(tileset.modelMatrix, transMatrix, modelMatrix);

            tileset.root.transform = modelMatrix.clone();

            var pos = Cesium.Cartesian3.fromDegrees(lng, lat, height);
            var headingPitchRoll = new Cesium.HeadingPitchRoll(0, 0, Cesium.Math.toRadians(0));
            modelMatrix = Cesium.Transforms.headingPitchRollToFixedFrame(new Cesium.Cartesian3(6378059, 0, 0), headingPitchRoll);

            Cesium.Matrix4.multiply(modelMatrix, tileset.modelMatrix, modelMatrix);

            // tileset.root.transform = modelMatrix;

        }

        // 移动模型
        function _enableTranslate() {

            let handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
            let pickedObject = null;
            let leftDownFlag = false;

            handler.setInputAction(function(movement) {
                pickedObject = viewer.scene.pick(movement.position);
                if (Cesium.defined(pickedObject)) {
                    if (pickedObject.primitive.isCesium3DTileset == undefined) {
                        leftDownFlag = true;
                        document.body.style.cursor = 'pointer';
                        viewer.scene.screenSpaceCameraController.enableRotate = false;//锁定相机
                        pickedObject.primitive.style = new Cesium.Cesium3DTileStyle({
                            color: {
                                conditions: [
                                    ['true', 'color("rgba(0,255,0,0.5)")']
                                ]
                            },
                        });
                    }
                }
            }, Cesium.ScreenSpaceEventType.LEFT_DOWN);

            handler.setInputAction(function() {
                leftDownFlag = false;
                if (pickedObject) {
                    pickedObject.primitive.style = new Cesium.Cesium3DTileStyle({
                        color: {
                            conditions: [
                                ['true', 'color("white")']
                            ]
                        },
                    });
                    pickedObject = null;
                    viewer.scene.screenSpaceCameraController.enableRotate = true;//解除锁定相机
                    //handler.destroy();//销毁左键监听事件
                    document.body.style.cursor = 'default';
                }


            }, Cesium.ScreenSpaceEventType.LEFT_UP);

            handler.setInputAction((movement) => {
                if (false && pickedObject.primitive.modelMatrix) {

                    // ************关键代码：cartesian的值************
                    let ray = viewer.camera.getPickRay(movement.endPosition);
                    let cartesian = viewer.scene.globe.pick(ray, viewer.scene);
                    if (cartesian) {
                        let cartographic = Cesium.Cartographic.fromCartesian(cartesian);
                        cartographic.height = modelHeight;
                        cartesian = Cesium.Cartesian3.fromRadians(cartographic.longitude, cartographic.latitude, cartographic.height);
                        let headingPitchRoll = new Cesium.HeadingPitchRoll(Cesium.Math.toRadians(0), 0, 0);
                        let m = Cesium.Transforms.headingPitchRollToFixedFrame(cartesian, headingPitchRoll);
                        pickedObject.primitive.modelMatrix = m;
                    }
                }
            }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);
        }
    </script>
</body>

</html>